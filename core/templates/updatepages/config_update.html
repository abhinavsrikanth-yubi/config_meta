<!DOCTYPE html>
<html>
<head>
    <title>Update Config</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container py-5">
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <h3>Update Config</h3>
        </div>
        <div class="card-body">
            {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            {% endif %}
            <form method="post" action="{% url 'config_update' config.config_id %}">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="config_id" class="form-label">Config ID</label>
                    <input type="text" class="form-control" id="config_id" name="config_id" value="{{ config.config_id }}" readonly>
                </div>
                <div class="mb-3">
                    <label for="parent_question_operator" class="form-label">Parent Question Operator</label>
                    <input type="text" class="form-control" id="parent_question_operator" name="parent_question_operator" value="{{ config.parent_question_operator }}">
                </div>
                <div class="mb-3">
                    <label for="default_option" class="form-label">Default Option</label>
                    <input type="text" class="form-control" id="default_option" name="default_option" value="{{ config.default_option }}">
                </div>
                <div class="mb-3">
    <label class="form-label">Parent Response Condition</label>
    <div id="prc-rows"></div>
    <button type="button" class="btn btn-success btn-sm mt-2" onclick="addPRCRow()">+</button>
    <input type="hidden" id="parent_response_condition" name="parent_response_condition">
</div>
<script>
    // Initialize questions from Django template variable
    const questions = JSON.parse('{{ questions_json|safe|escapejs }}');
    
    // Function to add a new row
    function addPRCRow(selectedQ = '', value = '') {
        const row = document.createElement('div');
        row.className = 'd-flex mb-2 align-items-center prc-row';
        row.innerHTML = `
            <select class="form-select me-2" style="width:250px">
                <option value="">Select a Question</option>
                ${questions.map(q => `<option value="${q.id}" ${q.id == selectedQ ? 'selected' : ''}>${q.label}</option>`).join('')}
            </select>
            <input type="text" class="form-control me-2" style="width:250px" value="${value}">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentNode.remove()">-</button>
        `;
        document.getElementById('prc-rows').appendChild(row);
    }
    
    // Initialize existing rows when page loads
    (function() {
        let existing = {};
        try {
            existing = JSON.parse('{{ config.parent_response_condition|default:'{}'|safe|escapejs }}');
        } catch (e) {
            existing = {};
        }
        if (!existing || Object.keys(existing).length === 0) {
            addPRCRow();
        } else {
            Object.entries(existing).forEach(([qid, valArr]) => {
                addPRCRow(qid, valArr[0] || '');
            });
        }
    })();
    
    // Handle form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const rows = document.querySelectorAll('.prc-row');
        const data = {};
        Array.from(rows).forEach(row => {
            const q = row.querySelector('select').value;
            const v = row.querySelector('input').value;
            if (q) data[q] = [v];
        });
        document.getElementById('parent_response_condition').value = JSON.stringify(data);
    });
</script>
                <div class="mb-3">
                    <label for="possbile_options" class="form-label">Possible Options</label>
                    <input type="text" class="form-control" id="possbile_options" name="possbile_options" value="{{ config.possbile_options }}">
                </div>
                <div class="mb-3">
                    <label for="parent_option_condition" class="form-label">Parent Option Condition</label>
                    <input type="text" class="form-control" id="parent_option_condition" name="parent_option_condition" value="{{ config.parent_option_condition }}">
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <input type="text" class="form-control" id="category" name="category" value="{{ config.category }}">    
                </div>
                <div class="mb-3"> 
                    <label for="is_active" class="form-label">Is Active</label>
                    <input type="checkbox" class="form-check-input" id="is_active" name="is_active" value="1" {% if config.is_active %}checked{% endif %}>
                </div>
                <div class="mb-3">
                    <label for="skip_trigger" class="form-label">Skip Trigger</label>
                    <input type="checkbox" class="form-check-input" id="skip_trigger" name="skip_trigger" value="1" {% if config.skip_trigger %}checked{% endif %}>
                </div>
                <div class="mb-3">
                    <label for="question_type" class="form-label">Question Type</label>
                    <input type="text" class="form-control" id="question_type" name="question_type" value="{{ config.question_type }}">
                </div>
                    <button type="submit" class="btn btn-success">Update</button>
                    <a href="/config/view/" class="btn btn-secondary ms-2">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
